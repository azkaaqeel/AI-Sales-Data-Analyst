from modules.KPI_Module.KPI_Engine import match_column, normalize_column_name, match_kpis, calculate_semantic_similarity

def KPI_Detection(df, combined_kpis):
    """
    Detect KPIs and return a list of potential KPIs
    for user review before calculation.
    """
    df.columns = [normalize_column_name(col) for col in df.columns]
    df_columns = df.columns.tolist()
    kpi_status = match_kpis(df_columns, combined_kpis=combined_kpis, df=df, semantic_match_fn=calculate_semantic_similarity)

    # Extract minimal info for UI
    detected_kpis = [
        {
            "name": name,
            "description": data["kpi_info"].get("description", ""),
        }
        for name, data in kpi_status.items()
        if data.get("calculable", False)
    ]

    # Return all info so backend can continue later
    return {
        "status": "awaiting_user_selection",
        "kpi_status": kpi_status,
        "detected_kpis": detected_kpis
    }